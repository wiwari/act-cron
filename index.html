<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>南勢溪水量觀察</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.7.0/sql-wasm.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.12.1.min.js"></script>
</head>
<body>
    <h1>南勢溪水量觀察</h1>
    <script>
        // transpose        
        function getDataSourcesFromResultSet(resultSet) {
            transposed = {};
                for (col in resultSet[0].columns) {
                    // console.log(resultSet[0].columns[col])
                    transposed[resultSet[0].columns[col]]=[ ];
                    for (val in resultSet[0].values) {
                        // console.log(resultSet[0].values[val][col])
                        transposed[resultSet[0].columns[col]][val]=resultSet[0].values[val][col];
                    }
                }
                 console.log (transposed)
                return transposed;
            }


        // const initSqlJs = window.initSqlJs;

        // load lastest daily flow on every station
        const loadLatestFlow = async () => {
            const sqlPromise  =  await initSqlJs({
    // Required to load the wasm binary asynchronously. Of course, you can host it wherever you want
    // You can omit locateFile completely when running in node
            locateFile: filename  => `https://sql.js.org/dist/${filename}`
            });
            const dataPromise = fetch("data/fhy-reservoir.db").then(res => res.arrayBuffer());
            // const dataPromise = fetch("https://github.com/wiwari/act-cron/raw/action/data/fhy-reservoir.db").then(res => res.arrayBuffer());
            const [SQL, buf] = await Promise.all([sqlPromise, dataPromise])
            const db = new SQL.Database(new Uint8Array(buf));
            // let sqlstr = 'select StationNo, max(Time), InflowTotal, OutflowTotal from daily  group by StationNo ORDER by StationNo  ;'
            let sqlstr = "SELECT json_object( 'StationNo', StationNo,'Time', max(Time),'InflowTotal', InflowTotal ,'OutflowTotal' , OutflowTotal) FROM daily  group by StationNo ORDER by StationNo ;"
            res =( db.exec(sqlstr));
            db.close();
        }



        const plotQuery = async () => {
            //查看南勢溪過去11天流量
            const sqlPromise  =  await initSqlJs({
    // Required to load the wasm binary asynchronously. Of course, you can host it wherever you want
    // You can omit locateFile completely when running in node
            locateFile: filename  => `https://sql.js.org/dist/${filename}`
            });
            const dataPromise = fetch("data/fhy-reservoir.db").then(res => res.arrayBuffer());
            // const dataPromise = fetch("https://github.com/wiwari/act-cron/raw/action/data/fhy-reservoir.db").then(res => res.arrayBuffer());
            const [SQL, buf] = await Promise.all([sqlPromise, dataPromise])
            const db = new SQL.Database(new Uint8Array(buf));
            let sqlstr = "SELECT  (Time), round (InflowTotal * 10000.0 /24/3600,2) as Inflow  from daily where StationNo='10213' ORDER by date(time) desc limit 11;"
            // let sqlstr = "SELECT  (Time), InflowTotal from daily where StationNo='10213' ORDER by date(time) asc;"
            plotdata =( db.exec(sqlstr));
            db.close();
            
            // console.log(JSON.stringify(getDataSourcesFromResultSet(plotdata), null, 4))
            // for ( idx in plotdata){
            //     console.log(plotdata[idx]["Time"]);
            // }
            
            Plotly.newPlot(document.getElementById('tester'), [{
                x: getDataSourcesFromResultSet(plotdata)['Time'],
                y: getDataSourcesFromResultSet(plotdata)['Inflow'],

                type: 'scatter',
                name: "羅好壩流量"

            }], {
                margin: { t: 30 },                
                title: '南勢溪羅好壩',
                xaxis: {
                    title: {
                        text: '日期',
                    },
                    type: 'date',
                    tickformat: '%m-%d (%a)\n %Y'
                },
                yaxis: {
                    range: [0, 30] ,
                    title: {
                        text: '日平均流量 m³/s (cms)',
                    },
                    type: 'linear'
                },
            });
        }




        // loadLatestFlow();
        plotQuery();
    </script>

    <div id="tester" style="width:600px;height:600px;"></div>
    <script>


    
    </script>
    
</body>
</html>